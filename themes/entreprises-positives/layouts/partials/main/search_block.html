{{- partial "utils/block_style.html" (dict "context" (dict "background" $.context.background) "nominh" true "pagecontext" $.pagecontext) -}}
{{$blockstyle := $.pagecontext.Scratch.Get "blockstyle"}}

<div class="container-fluid {{$blockstyle.cssclasses}}" style="{{$blockstyle.inlinestyle}}">
    <div class="container search-block">
        <div class="search-row-1">
            <div id="search-input" class="search-input"></div>
            <div>
                <a class="btn btn-primary" onclick="redirectToAction()">Résultats</a>
            </div>
        </div>
        <div class="search-row-2">
            <div class="d-flex">
                <div id="nature-list" class="refinement-select mr-4">
                </div>
                <div id="maturity-list" class="refinement-select mr-4">
                </div>
                <div id="financialinvest-list" class="refinement-select mr-4">
                </div>
                <div id="humaninvest-list" class="refinement-select mr-4">
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.0/dist/algoliasearch-lite.umd.js" integrity="sha256-MfeKq2Aw9VAkaE9Caes2NOxQf6vUa8Av0JqcUXUGkd0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.0.0/dist/instantsearch.production.min.js" integrity="sha256-6S7q0JJs/Kx4kb/fv0oMjS855QTz5Rc2hh9AkIUjUsk=" crossorigin="anonymous"></script>
<!-- Instant search.js -->
<script type="text/javascript">
    // Custom refinements list as select.
    const renderRefinementSelect = (renderOptions, isFirstRender) => {
        const {
            items,
            isFromSearch,
            refine,
            createURL,
            isShowingMore,
            canToggleShowMore,
            searchForItems,
            toggleShowMore,
            widgetParams,
        } = renderOptions;

        const container = document.querySelector(widgetParams.container);

        if (isFirstRender) {
            const input = document.createElement('select');
            const optionDefault = document.createElement('option');

            optionDefault.innerText = widgetParams.displayName;
            optionDefault.value = 'reset';

            input.addEventListener('input', event => {
                if (event.target.value === 'reset') {
                    refine([]);
                } else {
                    refine([event.target.value]);

                }
            });

            container.appendChild(input);
            input.appendChild(optionDefault);
        }

        const select = container.querySelector('select');

        items.forEach(
            item => {
                const option = select.querySelector(`option[value=${item.value}]`);
                if (option === undefined || option === null) {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.innerText = item.label;
                    select.appendChild(option);
                }
            }
        )
    };

    // 2. Create the custom widget
    const customRefinementSelect = instantsearch.connectors.connectRefinementList(
        renderRefinementSelect
    );
</script>
<script type="text/javascript">
    const searchClient = algoliasearch('9JQD047M0B', '7f0a4d6af72e524d8ebd42171af8957d');

    const search = instantsearch({
        indexName: 'actions',
        searchClient: searchClient,
        routing: false
    });

    search.addWidgets([
        instantsearch.widgets.searchBox({
            container: '#search-input',
            placeholder: 'Votre recherche',
            showReset: false,
            showSubmit: false
        }),
        customRefinementSelect({
            container: '#nature-list',
            displayName: "Nature de l'impact",
            attribute: 'nature',
        }),
        customRefinementSelect({
            container: '#maturity-list',
            displayName: "Maturité",
            attribute: 'maturity',
        }),
        customRefinementSelect({
            container: '#financialinvest-list',
            displayName: "Investissement financier",
            attribute: 'financialinvest',
        }),
        customRefinementSelect({
            container: '#humaninvest-list',
            displayName: "Investissement humain",
            attribute: 'humaninvest',
        })
    ]);

    search.start();

    function redirectToAction() {
        const {origin, pathname, hash} = location;

        const refinements = search.helper.state.disjunctiveFacetsRefinements;

        var query = [];
        if (refinements.nature.length > 0) {
            refinements.nature.map((value, index) => query.push(`actions[refinementList][nature][${index}]=${value}`));
        }
        if (refinements.maturity.length > 0) {
            refinements.maturity.map((value, index) => query.push(`actions[refinementList][maturity][${index}]=${value}`));
        }
        if (refinements.financialinvest.length > 0) {
            refinements.financialinvest.map((value, index) => query.push(`actions[refinementList][financialinvest][${index}]=${value}`));
        }
        if (refinements.humaninvest.length > 0) {
            refinements.humaninvest.map((value, index) => query.push(`actions[refinementList][humaninvest][${index}]=${value}`));
        }
        if (search.helper.state.query.length > 0) {
            query.push(`actions[query]=${search.helper.state.query}`);
        }

        window.location.href = `${origin}/actions/?${query.join('&')}${hash}`;
    }
</script>